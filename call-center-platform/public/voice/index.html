<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice AI ‚Äî Real-Time Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0b0f1a;
            --surface: #131829;
            --surface2: #1a2038;
            --border: #252d4a;
            --primary: #7c5cfc;
            --primary-glow: rgba(124, 92, 252, .25);
            --green: #00d4aa;
            --red: #ff4757;
            --yellow: #ffc312;
            --text: #e8eaed;
            --muted: #8b95a5;
            --font: 'Inter', system-ui, sans-serif
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center
        }

        /* ‚îÄ‚îÄ‚îÄ Auth Overlay ‚îÄ‚îÄ‚îÄ */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .85);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 380px;
            text-align: center
        }

        .auth-card h2 {
            margin-bottom: 8px;
            font-size: 1.4rem
        }

        .auth-card p {
            color: var(--muted);
            font-size: .85rem;
            margin-bottom: 24px
        }

        .auth-card input {
            width: 100%;
            padding: 12px 16px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: var(--font);
            margin-bottom: 12px;
            font-size: .9rem
        }

        .auth-card input:focus {
            outline: none;
            border-color: var(--primary)
        }

        .auth-card button {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, var(--primary), #6c3cec);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: .95rem;
            margin-top: 8px
        }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .container {
            width: 100%;
            max-width: 900px;
            padding: 30px 20px
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 700
        }

        .header h1 span {
            color: var(--primary)
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: .7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .badge.live {
            background: rgba(0, 212, 170, .15);
            color: var(--green);
            animation: pulse 2s infinite
        }

        .badge.offline {
            background: rgba(255, 71, 87, .15);
            color: var(--red)
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .logout-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--muted);
            cursor: pointer;
            font-size: .8rem
        }

        /* ‚îÄ‚îÄ‚îÄ Providers ‚îÄ‚îÄ‚îÄ */
        .providers {
            display: flex;
            gap: 12px;
            margin-bottom: 24px
        }

        .provider-chip {
            padding: 6px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: .7rem;
            color: var(--muted)
        }

        .provider-chip b {
            color: var(--text)
        }

        /* ‚îÄ‚îÄ‚îÄ Main Card ‚îÄ‚îÄ‚îÄ */
        .voice-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden
        }

        .voice-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, var(--primary-glow) 0%, transparent 50%);
            opacity: 0;
            transition: opacity .5s
        }

        .voice-card.active::before {
            opacity: 1;
            animation: glow 3s ease-in-out infinite
        }

        @keyframes glow {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.1)
            }
        }

        .mic-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--border);
            background: var(--surface2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            transition: all .3s;
            position: relative;
            z-index: 1
        }

        .mic-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05)
        }

        .mic-btn.recording {
            border-color: var(--red);
            background: rgba(255, 71, 87, .1);
            animation: mic-pulse 1.5s infinite
        }

        .mic-btn svg {
            width: 36px;
            height: 36px;
            fill: var(--muted);
            transition: fill .3s
        }

        .mic-btn.recording svg {
            fill: var(--red)
        }

        @keyframes mic-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 71, 87, .3)
            }

            50% {
                box-shadow: 0 0 0 20px rgba(255, 71, 87, 0)
            }
        }

        .status-text {
            font-size: .85rem;
            color: var(--muted);
            margin-bottom: 20px;
            min-height: 20px
        }

        .waveform {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            margin-bottom: 20px
        }

        .waveform .bar {
            width: 4px;
            border-radius: 4px;
            background: var(--primary);
            opacity: .3;
            transition: height .1s
        }

        .waveform.active .bar {
            animation: wave .8s ease-in-out infinite;
            opacity: .8
        }

        @keyframes wave {

            0%,
            100% {
                height: 8px
            }

            50% {
                height: 40px
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Transcript ‚îÄ‚îÄ‚îÄ */
        .transcript-area {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            text-align: left;
            max-height: 400px;
            overflow-y: auto
        }

        .transcript-area h3 {
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 16px
        }

        .msg {
            padding: 10px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            max-width: 85%;
            font-size: .9rem;
            line-height: 1.5;
            animation: fadeIn .3s
        }

        .msg.user {
            background: rgba(124, 92, 252, .12);
            border: 1px solid rgba(124, 92, 252, .2);
            margin-left: auto;
            text-align: right
        }

        .msg.assistant {
            background: var(--surface2);
            border: 1px solid var(--border)
        }

        .msg.system {
            background: rgba(255, 195, 18, .08);
            border: 1px solid rgba(255, 195, 18, .15);
            color: var(--yellow);
            font-size: .8rem;
            text-align: center;
            max-width: 100%
        }

        .msg .label {
            font-size: .65rem;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--muted);
            margin-bottom: 4px
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        /* ‚îÄ‚îÄ‚îÄ Text Input Fallback ‚îÄ‚îÄ‚îÄ */
        .text-input-area {
            display: flex;
            gap: 10px;
            margin-top: 16px
        }

        .text-input-area input {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: var(--font)
        }

        .text-input-area button {
            padding: 12px 24px;
            background: var(--primary);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-weight: 600;
            cursor: pointer
        }

        /* ‚îÄ‚îÄ‚îÄ Metrics ‚îÄ‚îÄ‚îÄ */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 24px
        }

        .metric-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center
        }

        .metric-card .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary)
        }

        .metric-card .label {
            font-size: .7rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-top: 4px
        }

        /* ‚îÄ‚îÄ‚îÄ Handoff Banner ‚îÄ‚îÄ‚îÄ */
        .handoff-banner {
            background: linear-gradient(135deg, rgba(255, 71, 87, .15), rgba(255, 195, 18, .1));
            border: 1px solid rgba(255, 71, 87, .3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 16px;
            display: none;
            align-items: center;
            gap: 12px
        }

        .handoff-banner.show {
            display: flex
        }

        .handoff-banner .icon {
            font-size: 1.5rem
        }

        .handoff-banner .info {
            flex: 1
        }

        .handoff-banner .info h4 {
            color: var(--red);
            font-size: .9rem
        }

        .handoff-banner .info p {
            color: var(--muted);
            font-size: .8rem
        }

        .lang-btn {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            opacity: .5;
            transition: all .2s
        }

        .lang-btn:hover {
            opacity: .8;
            background: rgba(124, 92, 252, 0.1)
        }

        .lang-btn.active {
            opacity: 1;
            background: rgba(124, 92, 252, 0.2);
            box-shadow: 0 0 0 1px var(--primary)
        }
    </style>
</head>

<body>

    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <h2>üéôÔ∏è Voice AI Demo</h2>
            <p>Sign in to start a real-time voice session</p>
            <input type="text" id="loginTenant" value="atlas_support" placeholder="Tenant ID">
            <input type="email" id="loginEmail" value="admin@atlas.com" placeholder="Email">
            <input type="password" id="loginPassword" value="password123" placeholder="Password">
            <div style="display:flex;align-items:center;gap:10px;width:100%">
                <label style="color:var(--muted);font-size:.85rem;white-space:nowrap">üåê Language</label>
                <select id="loginLanguage"
                    style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.9rem;cursor:pointer">
                    <option value="tr">üáπüá∑ T√ºrk√ße</option>
                    <option value="en">üá¨üáß English</option>
                </select>
            </div>
            <button onclick="doLogin()">Connect</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è <span>Voice AI</span> Studio</h1>
            <div style="display:flex;align-items:center;gap:12px">
                <div id="langSwitcher"
                    style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;display:none;gap:2px">
                    <button class="lang-btn active" id="langBtnTr" onclick="changeLanguage('tr')"
                        title="T√ºrk√ße">üáπüá∑</button>
                    <button class="lang-btn" id="langBtnEn" onclick="changeLanguage('en')" title="English">üá¨üáß</button>
                </div>
                <span class="badge offline" id="statusBadge">OFFLINE</span>
                <button class="logout-btn" onclick="disconnect()">Disconnect</button>
            </div>
        </div>

        <div class="providers" id="providers"></div>

        <!-- Voice Card -->
        <div class="voice-card" id="voiceCard">
            <button class="mic-btn" id="micBtn" onclick="toggleMic()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z" />
                    <path
                        d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
            </button>

            <div class="waveform" id="waveform">
                <div class="bar" style="animation-delay:0s"></div>
                <div class="bar" style="animation-delay:.1s"></div>
                <div class="bar" style="animation-delay:.2s"></div>
                <div class="bar" style="animation-delay:.3s"></div>
                <div class="bar" style="animation-delay:.15s"></div>
                <div class="bar" style="animation-delay:.25s"></div>
                <div class="bar" style="animation-delay:.05s"></div>
                <div class="bar" style="animation-delay:.35s"></div>
                <div class="bar" style="animation-delay:.12s"></div>
                <div class="bar" style="animation-delay:.22s"></div>
                <div class="bar" style="animation-delay:.08s"></div>
                <div class="bar" style="animation-delay:.18s"></div>
            </div>

            <p class="status-text" id="statusText">Click the microphone or type below to start</p>
        </div>

        <!-- Text Input Fallback -->
        <div class="text-input-area">
            <input type="text" id="textInput" placeholder="Type a message instead..."
                onkeydown="if(event.key==='Enter')sendText()">
            <button onclick="sendText()">Send</button>
        </div>

        <!-- Handoff Banner -->
        <div class="handoff-banner" id="handoffBanner">
            <div class="icon">üö®</div>
            <div class="info">
                <h4>Human Handoff Triggered</h4>
                <p id="handoffReason">‚Äî</p>
            </div>
        </div>

        <!-- Conversation Transcript -->
        <div class="transcript-area" id="transcriptArea">
            <h3>üí¨ Conversation</h3>
            <div id="messages"></div>
        </div>

        <!-- Metrics -->
        <div class="metrics-row">
            <div class="metric-card">
                <div class="value" id="metricTurns">0</div>
                <div class="label">Turns</div>
            </div>
            <div class="metric-card">
                <div class="value" id="metricLatency">‚Äî</div>
                <div class="label">Avg Latency</div>
            </div>
            <div class="metric-card">
                <div class="value" id="metricTokens">0</div>
                <div class="label">Tokens</div>
            </div>
            <div class="metric-card">
                <div class="value" id="metricDuration">0:00</div>
                <div class="label">Duration</div>
            </div>
        </div>
    </div>

    <script>
        let token = null;
        let ws = null;
        let sessionId = null;
        let isRecording = false;
        let mediaRecorder = null;
        let sessionStart = null;
        let turns = 0;
        let totalTokens = 0;
        let latencies = [];
        let durationTimer = null;
        let currentLanguage = 'tr';

        const BASE = location.origin;
        const WS_BASE = `ws://${location.host}`;

        // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function doLogin() {
            const tenant_id = document.getElementById('loginTenant').value;
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            currentLanguage = document.getElementById('loginLanguage').value;

            try {
                const res = await fetch(`${BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, tenant_id })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                token = data.token;
                document.getElementById('authOverlay').style.display = 'none';
                // Show language switcher and set active
                const switcher = document.getElementById('langSwitcher');
                switcher.style.display = 'flex';
                updateLangButtons();
                connectWebSocket();
            } catch (e) {
                alert('Login failed: ' + e.message);
            }
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            updateLangButtons();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'set_language', language: lang }));
            }
        }

        function updateLangButtons() {
            document.getElementById('langBtnTr').className = `lang-btn${currentLanguage === 'tr' ? ' active' : ''}`;
            document.getElementById('langBtnEn').className = `lang-btn${currentLanguage === 'en' ? ' active' : ''}`;
        }

        // ‚îÄ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function connectWebSocket() {
            ws = new WebSocket(`${WS_BASE}/ws/voice?token=${token}`);

            ws.onopen = () => {
                document.getElementById('statusBadge').className = 'badge live';
                document.getElementById('statusBadge').textContent = 'CONNECTED';
                document.getElementById('statusText').textContent = currentLanguage === 'tr' ? 'Oturum aktif ‚Äî konu≈üabilir veya yazabilirsiniz' : 'Session active ‚Äî speak or type';
                ws.send(JSON.stringify({ type: 'start', language: currentLanguage }));
                sessionStart = Date.now();
                durationTimer = setInterval(updateDuration, 1000);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleServerMessage(msg);
            };

            ws.onclose = () => {
                document.getElementById('statusBadge').className = 'badge offline';
                document.getElementById('statusBadge').textContent = 'DISCONNECTED';
                document.getElementById('statusText').textContent = 'Connection closed';
                if (durationTimer) clearInterval(durationTimer);
            };

            ws.onerror = () => {
                document.getElementById('statusText').textContent = 'Connection error';
            };
        }

        function handleServerMessage(msg) {
            switch (msg.type) {
                case 'session_start':
                    sessionId = msg.sessionId;
                    renderProviders(msg.providers);
                    addSystemMessage(`Session started: ${sessionId.slice(0, 8)}`);
                    break;

                case 'ready':
                    document.getElementById('statusText').textContent = currentLanguage === 'tr' ? 'Hazƒ±r ‚Äî mesajƒ±nƒ±zƒ± s√∂yleyin veya yazƒ±n' : 'Ready ‚Äî speak or type your message';
                    break;

                case 'language_changed':
                    currentLanguage = msg.language;
                    updateLangButtons();
                    addSystemMessage(currentLanguage === 'tr' ? `Dil T√ºrk√ße olarak ayarlandƒ±` : `Language set to English`);
                    break;

                case 'partial_transcript':
                    document.getElementById('statusText').textContent = `Hearing: "${msg.text}"...`;
                    break;

                case 'transcript':
                    addMessage('user', msg.text);
                    document.getElementById('statusText').textContent = 'AI is thinking...';
                    break;

                case 'response_text':
                    if (msg.isFinal) {
                        // Final sentence of response
                        addMessage('assistant', msg.text);
                        document.getElementById('statusText').textContent = 'Ready for next message';
                        turns++;
                        document.getElementById('metricTurns').textContent = turns;
                    } else {
                        addMessage('assistant', msg.text);
                    }
                    break;

                case 'response_audio':
                    if (msg.type === 'browser_tts' || msg.type === 'response_audio' && msg.text) {
                        // Use browser TTS
                        speakText(msg.text);
                    }
                    break;

                case 'handoff':
                    document.getElementById('handoffBanner').classList.add('show');
                    document.getElementById('handoffReason').textContent = msg.reason;
                    addSystemMessage(`‚ö†Ô∏è Handoff: ${msg.reason}`);
                    document.getElementById('statusText').textContent = 'Transferring to human agent...';
                    break;

                case 'session_end':
                    addSystemMessage('Session ended');
                    break;

                case 'error':
                    addSystemMessage(`Error: ${msg.message}`);
                    break;
            }
        }

        // ‚îÄ‚îÄ‚îÄ Microphone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function toggleMic() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && ws && ws.readyState === 1) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            ws.send(JSON.stringify({ type: 'audio', data: base64 }));
                        };
                        reader.readAsDataURL(event.data);
                    }
                };

                mediaRecorder.start(250); // Send chunks every 250ms
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('waveform').classList.add('active');
                document.getElementById('voiceCard').classList.add('active');
                document.getElementById('statusText').textContent = 'Listening...';
            } catch (e) {
                document.getElementById('statusText').textContent = 'Microphone access denied ‚Äî use text input';
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
            }
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            document.getElementById('waveform').classList.remove('active');
            document.getElementById('voiceCard').classList.remove('active');

            // Flush STT
            if (ws && ws.readyState === 1) {
                ws.send(JSON.stringify({ type: 'end' }));
            }
        }

        // ‚îÄ‚îÄ‚îÄ Text Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            if (!text || !ws || ws.readyState !== 1) return;

            const sent = Date.now();
            addMessage('user', text);
            ws.send(JSON.stringify({ type: 'text', data: text }));
            input.value = '';
            document.getElementById('statusText').textContent = 'AI is thinking...';

            // Track latency for next response
            const origHandler = ws.onmessage;
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'response_text') {
                    const latency = Date.now() - sent;
                    latencies.push(latency);
                    const avg = Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length);
                    document.getElementById('metricLatency').textContent = avg + 'ms';
                }
                handleServerMessage(msg);
            };
        }

        // ‚îÄ‚îÄ‚îÄ Browser TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        // ‚îÄ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function addMessage(role, text) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            const label = role === 'user' ? 'üßë You' : 'ü§ñ AI';
            div.innerHTML = `<div class="label">${label}</div>${text}`;
            container.appendChild(div);
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'msg system';
            div.textContent = text;
            container.appendChild(div);
        }

        function renderProviders(providers) {
            if (!providers) return;
            const el = document.getElementById('providers');
            el.innerHTML = `
    <div class="provider-chip">STT: <b>${providers.stt}</b></div>
    <div class="provider-chip">LLM: <b>${providers.llm}</b></div>
    <div class="provider-chip">TTS: <b>${providers.tts}</b></div>
  `;
        }

        function updateDuration() {
            if (!sessionStart) return;
            const secs = Math.floor((Date.now() - sessionStart) / 1000);
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            document.getElementById('metricDuration').textContent = `${m}:${String(s).padStart(2, '0')}`;
        }

        function disconnect() {
            if (ws) {
                ws.send(JSON.stringify({ type: 'end' }));
                ws.close();
            }
            if (durationTimer) clearInterval(durationTimer);
            token = null;
            document.getElementById('authOverlay').style.display = 'flex';
        }
    </script>
</body>

</html>