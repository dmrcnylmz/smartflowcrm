<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Call Center Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #111827;
      --bg-card: rgba(17, 24, 39, 0.8);
      --bg-glass: rgba(255, 255, 255, 0.05);
      --border-glass: rgba(255, 255, 255, 0.1);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-blue: #3b82f6;
      --accent-purple: #8b5cf6;
      --accent-green: #10b981;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
      --accent-cyan: #06b6d4;
      --brand-primary: #7c5cfc;
      --brand-secondary: #00d4aa;
      --gradient-1: linear-gradient(135deg, #3b82f6, #8b5cf6);
      --gradient-2: linear-gradient(135deg, #10b981, #06b6d4);
      --gradient-3: linear-gradient(135deg, #f59e0b, #ef4444);
      --gradient-4: linear-gradient(135deg, #8b5cf6, #ec4899);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
      animation: drift 20s ease-in-out infinite;
      z-index: 0;
    }

    @keyframes drift {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      50% {
        transform: translate(-20px, -20px) rotate(1deg);
      }
    }

    .app {
      position: relative;
      z-index: 1;
    }

    .header {
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-glass);
      backdrop-filter: blur(20px);
      background: rgba(10, 14, 26, 0.8);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      background: var(--gradient-1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .logo h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 400;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .tenant-badge {
      padding: 6px 14px;
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      font-size: 13px;
      color: var(--accent-cyan);
    }

    .login-section {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .login-section select,
    .login-section input {
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-glass);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }

    .btn {
      padding: 8px 18px;
      background: var(--gradient-1);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .main {
      padding: 24px 32px;
    }

    /* Metric Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border-glass);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    .metric-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      width: 100%;
      border-radius: 16px 16px 0 0;
    }

    .metric-card:nth-child(1)::after {
      background: var(--gradient-1);
    }

    .metric-card:nth-child(2)::after {
      background: var(--gradient-2);
    }

    .metric-card:nth-child(3)::after {
      background: var(--gradient-3);
    }

    .metric-card:nth-child(4)::after {
      background: var(--gradient-4);
    }

    .metric-card:nth-child(5)::after {
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
    }

    .metric-card:nth-child(6)::after {
      background: linear-gradient(135deg, #f97316, #f59e0b);
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -1px;
    }

    .metric-sub {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .m-blue {
      color: var(--accent-blue);
    }

    .m-green {
      color: var(--accent-green);
    }

    .m-orange {
      color: var(--accent-orange);
    }

    .m-purple {
      color: var(--accent-purple);
    }

    .m-cyan {
      color: var(--accent-cyan);
    }

    /* Panels Grid */
    .panels-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border-glass);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-glass);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
    }

    .panel-body {
      padding: 16px 20px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-glass);
    }

    .data-table td {
      padding: 10px 12px;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .data-table tr {
      cursor: pointer;
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-green {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }

    .badge-yellow {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }

    .badge-red {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    .badge-blue {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .badge-purple {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }

    .badge-cyan {
      background: rgba(6, 182, 212, 0.15);
      color: #22d3ee;
    }

    .badge-orange {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }

    /* Sentiment pill */
    .sentiment-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .sentiment-positive {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
    }

    .sentiment-neutral {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }

    .sentiment-negative {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    /* Intent badge */
    .intent-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .intent-appointment {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .intent-complaint {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    .intent-pricing {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }

    .intent-human {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }

    .intent-other {
      background: rgba(100, 116, 139, 0.15);
      color: #94a3b8;
    }

    /* Sentiment bar */
    .sentiment-bar {
      display: flex;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      gap: 2px;
    }

    .sentiment-pos {
      background: var(--accent-green);
    }

    .sentiment-neu {
      background: var(--accent-orange);
    }

    .sentiment-neg {
      background: var(--accent-red);
    }

    /* Intent donut chart */
    .intent-chart-container {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .intent-donut {
      position: relative;
      width: 140px;
      height: 140px;
      flex-shrink: 0;
    }

    .intent-donut svg {
      transform: rotate(-90deg);
    }

    .intent-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .intent-center strong {
      display: block;
      font-size: 22px;
      color: var(--text-primary);
    }

    .intent-legend {
      flex: 1;
    }

    .intent-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .intent-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .full-panel {
      grid-column: 1 / -1;
    }

    .call-log-table {
      max-height: 500px;
      overflow-y: auto;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-glass);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Auth overlay */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 14, 26, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .auth-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      padding: 40px;
      width: 420px;
      text-align: center;
    }

    .auth-card h2 {
      margin-bottom: 8px;
      font-size: 24px;
    }

    .auth-card p {
      color: var(--text-muted);
      margin-bottom: 24px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-primary);
      border: 1px solid var(--border-glass);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }

    .auth-card .btn {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      margin-top: 8px;
    }

    .auth-error {
      color: var(--accent-red);
      font-size: 13px;
      margin-top: 8px;
    }

    /* Queue bars */
    .queue-bar-container {
      margin-bottom: 12px;
    }

    .queue-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .queue-bar {
      height: 10px;
      background: var(--bg-primary);
      border-radius: 5px;
      overflow: hidden;
    }

    .queue-bar-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.6s ease;
    }

    /* Call detail modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--bg-glass);
      color: var(--text-primary);
    }

    .modal-header {
      padding: 24px 28px 16px;
      border-bottom: 1px solid var(--border-glass);
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .modal-header .meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 20px 28px 28px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {}

    .detail-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 500;
    }

    .ai-section {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .ai-section h4 {
      font-size: 12px;
      color: var(--accent-cyan);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-section p {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .transcript-box {
      background: var(--bg-primary);
      border: 1px solid var(--border-glass);
      border-radius: 10px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.8;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    @media (max-width: 768px) {
      .panels-grid {
        grid-template-columns: 1fr;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .main {
        padding: 16px;
      }

      .modal {
        width: 95%;
      }
    }
  </style>
</head>

<body>
  <!-- Auth Overlay -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
      <div class="logo-icon" style="margin: 0 auto 16px; width: 56px; height: 56px; font-size: 26px;">üéß</div>
      <h2>Admin Panel</h2>
      <p>AI-Powered Multi-Tenant Call Center</p>
      <div class="form-group">
        <label>Tenant</label>
        <select id="loginTenant">
          <option value="atlas_support">Atlas Support</option>
          <option value="nova_logistics">Nova Logistics</option>
        </select>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" value="admin@atlas.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" value="password123">
      </div>
      <button class="btn" onclick="doLogin()">Sign In</button>
      <div class="auth-error" id="authError"></div>
    </div>
  </div>

  <div class="app" id="app" style="display:none;">
    <header class="header">
      <div class="logo">
        <div class="logo-icon" id="brandLogo">üéß</div>
        <div>
          <h1 id="brandTitle">Call Center</h1>
          <span>Admin Dashboard</span>
        </div>
      </div>
      <div class="header-right">
        <span class="tenant-badge" id="tenantName">‚Äî</span>
        <button class="btn" onclick="logout()"
          style="background: var(--bg-glass); border: 1px solid var(--border-glass);">Logout</button>
      </div>
    </header>

    <main class="main">
      <div class="metrics-grid" id="metricsGrid">
        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top:12px">Loading metrics...</p>
        </div>
      </div>

      <div class="panels-grid">
        <!-- Agents Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">üë§ Agents</span>
            <span class="badge badge-blue" id="agentCount">0</span>
          </div>
          <div class="panel-body" id="agentsPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Queue Volume Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">üìä Call Volume by Queue</span>
          </div>
          <div class="panel-body" id="queuePanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Sentiment Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">üòä Sentiment Analysis</span>
          </div>
          <div class="panel-body" id="sentimentPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Intent Analysis Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">üß† AI Intent Breakdown</span>
          </div>
          <div class="panel-body" id="intentPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Resolution Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">‚úÖ Resolution Breakdown</span>
          </div>
          <div class="panel-body" id="resolutionPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Usage / Billing Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">üí∞ Usage & Billing</span>
          </div>
          <div class="panel-body" id="billingPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Telephony Panel -->
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">üì± Telephony</span>
            <span class="badge badge-purple" id="telephonyStatus">‚Äî</span>
          </div>
          <div class="panel-body" id="telephonyPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Recent Calls Table -->
        <div class="panel full-panel">
          <div class="panel-header">
            <span class="panel-title">üìû Recent Calls</span>
            <span class="badge badge-purple" id="callCount">0</span>
          </div>
          <div class="panel-body call-log-table" id="callsPanel">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Call Detail Modal -->
  <div class="modal-overlay" id="callModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div class="modal-header">
        <h3 id="modalTitle">Call Details</h3>
        <div class="meta" id="modalMeta"></div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const API = '';
    let token = null;
    let currentTenant = null;
    let allCalls = [];

    document.getElementById('loginTenant').addEventListener('change', function () {
      const emails = { atlas_support: 'admin@atlas.com', nova_logistics: 'admin@nova.com' };
      document.getElementById('loginEmail').value = emails[this.value] || '';
    });

    async function doLogin() {
      const tenant = document.getElementById('loginTenant').value;
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      document.getElementById('authError').textContent = '';
      try {
        const res = await fetch(`${API}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, tenant_id: tenant })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        token = data.token;
        currentTenant = tenant;
        localStorage.setItem('cc_token', token);
        localStorage.setItem('cc_tenant', tenant);
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadDashboard();
      } catch (err) {
        document.getElementById('authError').textContent = err.message;
      }
    }

    function logout() {
      token = null; currentTenant = null;
      localStorage.removeItem('cc_token'); localStorage.removeItem('cc_tenant');
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }

    async function apiFetch(url) {
      const res = await fetch(`${API}${url}`, { headers: { 'Authorization': `Bearer ${token}` } });
      if (res.status === 401) { logout(); throw new Error('Session expired'); }
      return res.json();
    }

    async function loadDashboard() {
      try {
        const [dashboard, agents, tenant, calls, branding, billing] = await Promise.all([
          apiFetch('/api/analytics/dashboard'),
          apiFetch('/api/tenants/me/agents'),
          apiFetch('/api/tenants/me'),
          apiFetch('/api/calls?limit=50'),
          apiFetch('/api/branding').catch(() => null),
          apiFetch('/api/billing/usage').catch(() => null)
        ]);

        document.getElementById('tenantName').textContent = tenant.name || currentTenant;

        // Apply branding
        if (branding && branding.primary_color) {
          document.documentElement.style.setProperty('--brand-primary', branding.primary_color);
          document.getElementById('brandTitle').textContent = branding.company_name || 'Call Center';
        }

        allCalls = calls.calls || [];
        renderMetrics(dashboard);
        renderAgents(agents.agents);
        renderQueues(dashboard.call_volume_by_queue);
        renderSentiment(dashboard.sentiment_distribution);
        renderIntentChart(allCalls);
        renderResolution(dashboard.resolution_breakdown);
        renderBilling(billing);
        loadTelephony();
        renderCalls(allCalls);
      } catch (err) {
        console.error('Dashboard load failed:', err);
      }
    }

    function renderMetrics(d) {
      const o = d.overview || {};
      const aiCount = allCalls.filter(c => c.intent).length;
      const html = `
        <div class="metric-card">
          <div class="metric-label">Total Calls</div>
          <div class="metric-value m-blue">${(o.total_calls || 0).toLocaleString()}</div>
          <div class="metric-sub">${o.inbound_calls || 0} inbound ¬∑ ${o.outbound_calls || 0} outbound</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Avg Handle Time</div>
          <div class="metric-value m-green">${d.average_handle_time?.formatted || '‚Äî'}</div>
          <div class="metric-sub">${d.average_handle_time?.seconds || 0}s per call</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Abandon Rate</div>
          <div class="metric-value m-orange">${d.abandon_rate?.rate || 0}%</div>
          <div class="metric-sub">${d.abandon_rate?.abandoned || 0} of ${d.abandon_rate?.total_inbound || 0} inbound</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">First Call Resolution</div>
          <div class="metric-value m-purple">${d.first_call_resolution?.rate || 0}%</div>
          <div class="metric-sub">${d.first_call_resolution?.resolved_first_call || 0} resolved</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Avg Sentiment</div>
          <div class="metric-value m-cyan">${o.avg_sentiment || 0}</div>
          <div class="metric-sub">${o.avg_sentiment >= 0.3 ? 'üòä Positive' : o.avg_sentiment >= -0.3 ? 'üòê Neutral' : 'üòü Negative'}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">AI Enriched</div>
          <div class="metric-value" style="color: var(--accent-cyan)">ü§ñ ${aiCount}</div>
          <div class="metric-sub">Calls with AI analysis</div>
        </div>
      `;
      document.getElementById('metricsGrid').innerHTML = html;
    }

    function renderAgents(agents) {
      document.getElementById('agentCount').textContent = agents.length;
      const statusColors = { available: 'badge-green', busy: 'badge-yellow', offline: 'badge-red', on_call: 'badge-blue', break: 'badge-purple' };
      const html = `<table class="data-table">
        <thead><tr><th>Agent</th><th>Role</th><th>Level</th><th>Status</th></tr></thead>
        <tbody>${agents.map(a => `
          <tr>
            <td style="font-weight:500">${a.name}</td>
            <td><span class="badge ${a.role === 'supervisor' ? 'badge-purple' : 'badge-blue'}">${a.role}</span></td>
            <td>${a.level}</td>
            <td><span class="badge ${statusColors[a.status] || 'badge-blue'}">${a.status}</span></td>
          </tr>
        `).join('')}</tbody>
      </table>`;
      document.getElementById('agentsPanel').innerHTML = html;
    }

    function renderQueues(queues) {
      if (!queues || !queues.length) return;
      const max = Math.max(...queues.map(q => q.total_calls || 1));
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444'];
      const html = queues.map((q, i) => `
        <div class="queue-bar-container">
          <div class="queue-bar-label">
            <span>${q.queue_name}</span>
            <span style="color:var(--text-muted)">${q.total_calls} calls</span>
          </div>
          <div class="queue-bar">
            <div class="queue-bar-fill" style="width:${(q.total_calls / max) * 100}%; background:${colors[i % colors.length]}"></div>
          </div>
        </div>
      `).join('');
      document.getElementById('queuePanel').innerHTML = html;
    }

    function renderSentiment(s) {
      if (!s) return;
      const total = (s.positive || 0) + (s.neutral || 0) + (s.negative || 0);
      if (!total) return;
      const html = `
        <div style="margin-bottom:16px">
          <div class="sentiment-bar">
            <div class="sentiment-pos" style="width:${(s.positive / total) * 100}%"></div>
            <div class="sentiment-neu" style="width:${(s.neutral / total) * 100}%"></div>
            <div class="sentiment-neg" style="width:${(s.negative / total) * 100}%"></div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:13px">
          <span>üòä Positive: <strong style="color:var(--accent-green)">${s.positive}</strong> (${((s.positive / total) * 100).toFixed(1)}%)</span>
          <span>üòê Neutral: <strong style="color:var(--accent-orange)">${s.neutral}</strong> (${((s.neutral / total) * 100).toFixed(1)}%)</span>
          <span>üòü Negative: <strong style="color:var(--accent-red)">${s.negative}</strong> (${((s.negative / total) * 100).toFixed(1)}%)</span>
        </div>
      `;
      document.getElementById('sentimentPanel').innerHTML = html;
    }

    function renderIntentChart(calls) {
      const intents = {};
      calls.forEach(c => {
        if (c.intent) intents[c.intent] = (intents[c.intent] || 0) + 1;
      });
      const total = Object.values(intents).reduce((s, v) => s + v, 0);
      if (!total) { document.getElementById('intentPanel').innerHTML = '<p style="color:var(--text-muted)">No AI data</p>'; return; }

      const colors = { appointment: '#3b82f6', complaint: '#ef4444', pricing: '#f59e0b', human: '#8b5cf6', other: '#64748b' };
      const icons = { appointment: 'üìÖ', complaint: '‚ö†Ô∏è', pricing: 'üí∞', human: 'üë§', other: 'üìã' };

      // SVG donut
      const r = 55, cx = 70, cy = 70, circumference = 2 * Math.PI * r;
      let offset = 0;
      let segments = '';
      const sorted = Object.entries(intents).sort((a, b) => b[1] - a[1]);

      sorted.forEach(([intent, count]) => {
        const pct = count / total;
        const dashLen = pct * circumference;
        const dashGap = circumference - dashLen;
        segments += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${colors[intent] || '#64748b'}" stroke-width="14" stroke-dasharray="${dashLen} ${dashGap}" stroke-dashoffset="${-offset}" />`;
        offset += dashLen;
      });

      const legend = sorted.map(([intent, count]) => `
        <div class="intent-legend-item">
          <div class="intent-dot" style="background:${colors[intent] || '#64748b'}"></div>
          <span>${icons[intent] || 'üìã'} ${intent}</span>
          <span style="margin-left:auto;font-weight:600;color:${colors[intent] || '#94a3b8'}">${count} <span style="color:var(--text-muted);font-weight:400">(${((count / total) * 100).toFixed(0)}%)</span></span>
        </div>
      `).join('');

      document.getElementById('intentPanel').innerHTML = `
        <div class="intent-chart-container">
          <div class="intent-donut">
            <svg width="140" height="140"><g>${segments}</g></svg>
            <div class="intent-center"><strong>${total}</strong>Total</div>
          </div>
          <div class="intent-legend">${legend}</div>
        </div>
      `;
    }

    function renderResolution(r) {
      if (!r || !r.length) return;
      const colors = { resolved: 'var(--accent-green)', follow_up: 'var(--accent-orange)', escalated: 'var(--accent-purple)', unresolved: 'var(--accent-red)' };
      const icons = { resolved: '‚úÖ', follow_up: 'üîÑ', escalated: '‚¨ÜÔ∏è', unresolved: '‚ùå' };
      const total = r.reduce((s, x) => s + x.count, 0);
      const html = r.map(x => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-glass)">
          <span>${icons[x.resolution_status] || '‚ùì'} ${x.resolution_status}</span>
          <span style="font-weight:600;color:${colors[x.resolution_status] || 'white'}">${x.count} <span style="color:var(--text-muted);font-weight:400">(${((x.count / total) * 100).toFixed(1)}%)</span></span>
        </div>
      `).join('');
      document.getElementById('resolutionPanel').innerHTML = html;
    }

    function renderBilling(usage) {
      if (!usage) { document.getElementById('billingPanel').innerHTML = '<p style="color:var(--text-muted)">No billing data</p>'; return; }
      const html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div>
            <div class="detail-label">Current Month</div>
            <div class="detail-value">${usage.month || '‚Äî'}</div>
          </div>
          <div>
            <div class="detail-label">Call Minutes</div>
            <div class="detail-value" style="color:var(--accent-green)">${(usage.call_minutes || 0).toLocaleString()} min</div>
          </div>
          <div>
            <div class="detail-label">AI Tokens</div>
            <div class="detail-value" style="color:var(--accent-cyan)">${(usage.ai_tokens || 0).toLocaleString()}</div>
          </div>
          <div>
            <div class="detail-label">Estimated Cost</div>
            <div class="detail-value" style="color:var(--accent-orange)">$${((usage.call_minutes || 0) * 0.02 + (usage.ai_tokens || 0) * 0.00001).toFixed(2)}</div>
          </div>
        </div>
      `;
      document.getElementById('billingPanel').innerHTML = html;
    }

    async function loadTelephony() {
      try {
        const res = await fetch('/api/twilio/config', { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed');
        const config = await res.json();
        renderTelephony(config);
      } catch (e) {
        document.getElementById('telephonyPanel').innerHTML = `
          <p style="color:var(--text-muted)">Telephony not configured</p>
          <div style="margin-top:12px">
            <div class="detail-label">Provider</div>
            <select id="telProvider" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-glass);background:var(--bg-glass);color:var(--text-primary);margin-bottom:8px">
              <option value="twilio">Twilio</option>
              <option value="sip">SIP</option>
            </select>
            <div class="detail-label">Account SID</div>
            <input id="telSid" type="text" placeholder="AC..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-glass);background:var(--bg-glass);color:var(--text-primary);margin-bottom:8px">
            <div class="detail-label">Auth Token</div>
            <input id="telToken" type="password" placeholder="Auth Token" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-glass);background:var(--bg-glass);color:var(--text-primary);margin-bottom:8px">
            <div class="detail-label">Phone Number</div>
            <input id="telPhone" type="text" placeholder="+1..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-glass);background:var(--bg-glass);color:var(--text-primary);margin-bottom:12px">
            <button class="btn" style="width:100%;background:var(--gradient-1)" onclick="saveTelephony()">Save & Enable</button>
          </div>`;
        document.getElementById('telephonyStatus').textContent = 'Not Configured';
        document.getElementById('telephonyStatus').className = 'badge badge-red';
      }
    }

    function renderTelephony(config) {
      const statusBadge = document.getElementById('telephonyStatus');
      statusBadge.textContent = config.enabled ? 'Active' : 'Disabled';
      statusBadge.className = config.enabled ? 'badge badge-green' : 'badge badge-red';

      document.getElementById('telephonyPanel').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <div class="detail-label">Provider</div>
            <div class="detail-value" style="color:var(--accent-purple)">${(config.provider || 'twilio').toUpperCase()}</div>
          </div>
          <div>
            <div class="detail-label">Status</div>
            <div class="detail-value" style="color:${config.enabled ? 'var(--accent-green)' : 'var(--accent-red)'}">${config.enabled ? 'üü¢ Active' : 'üî¥ Disabled'}</div>
          </div>
          <div>
            <div class="detail-label">Account SID</div>
            <div class="detail-value" style="font-size:12px">${config.account_sid || '‚Äî'}</div>
          </div>
          <div>
            <div class="detail-label">Auth Token</div>
            <div class="detail-value">${config.auth_token || '‚Äî'}</div>
          </div>
          <div style="grid-column:1/-1">
            <div class="detail-label">Phone Number</div>
            <div class="detail-value" style="color:var(--accent-cyan);font-size:18px">${config.phone_number || '‚Äî'}</div>
          </div>
        </div>
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn" style="flex:1;background:${config.enabled ? 'var(--accent-red)' : 'var(--accent-green)'};border:none;border-radius:8px;padding:8px;cursor:pointer;color:white;font-weight:600" onclick="toggleTelephony(${!config.enabled})">\n            ${config.enabled ? '‚è∏ Disable' : '‚ñ∂ Enable'}\n          </button>
        </div>`;
    }

    async function saveTelephony() {
      const body = {
        provider: document.getElementById('telProvider')?.value || 'twilio',
        account_sid: document.getElementById('telSid')?.value,
        auth_token: document.getElementById('telToken')?.value,
        phone_number: document.getElementById('telPhone')?.value,
        enabled: true
      };
      try {
        await fetch('/api/twilio/config', { method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        loadTelephony();
      } catch (e) { console.error('Save telephony failed', e); }
    }

    async function toggleTelephony(enabled) {
      try {
        await fetch('/api/twilio/config', { method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled }) });
        loadTelephony();
      } catch (e) { console.error('Toggle telephony failed', e); }
    }

    function sentimentPill(score) {
      if (score == null) return '<span style="color:var(--text-muted)">‚Äî</span>';
      if (score >= 0.3) return `<span class="sentiment-pill sentiment-positive">üòä ${score.toFixed(2)}</span>`;
      if (score >= -0.3) return `<span class="sentiment-pill sentiment-neutral">üòê ${score.toFixed(2)}</span>`;
      return `<span class="sentiment-pill sentiment-negative">üòü ${score.toFixed(2)}</span>`;
    }

    function intentBadge(intent) {
      if (!intent) return '<span style="color:var(--text-muted)">‚Äî</span>';
      return `<span class="intent-badge intent-${intent}">${intent}</span>`;
    }

    function renderCalls(calls) {
      document.getElementById('callCount').textContent = calls.length;
      const html = `<table class="data-table">
        <thead><tr><th>Time</th><th>Type</th><th>Agent</th><th>Queue</th><th>Duration</th><th>Status</th><th>Sentiment</th><th>Intent</th><th>AI Summary</th></tr></thead>
        <tbody>${calls.map(c => {
        const dur = c.duration ? `${Math.floor(c.duration / 60)}:${(c.duration % 60).toString().padStart(2, '0')}` : '‚Äî';
        const statusClass = c.status === 'completed' ? 'badge-green' : c.status === 'abandoned' ? 'badge-red' : 'badge-yellow';
        const summary = c.ai_summary ? (c.ai_summary.length > 40 ? c.ai_summary.slice(0, 40) + '‚Ä¶' : c.ai_summary) : '‚Äî';
        return `<tr onclick="showCallDetail('${c.id}')">
            <td style="color:var(--text-muted);font-size:12px">${new Date(c.started_at).toLocaleDateString('tr-TR')} ${new Date(c.started_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</td>
            <td><span class="badge ${c.call_type === 'inbound' ? 'badge-blue' : 'badge-purple'}">${c.call_type === 'inbound' ? 'üì• IN' : 'üì§ OUT'}</span></td>
            <td>${c.agent_name || '‚Äî'}</td>
            <td>${c.queue_name || '‚Äî'}</td>
            <td>${dur}</td>
            <td><span class="badge ${statusClass}">${c.status}</span></td>
            <td>${sentimentPill(c.sentiment_score)}</td>
            <td>${intentBadge(c.intent)}</td>
            <td style="font-size:11px;color:var(--text-secondary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${summary}</td>
          </tr>`;
      }).join('')}</tbody>
      </table>`;
      document.getElementById('callsPanel').innerHTML = html;
    }

    async function showCallDetail(callId) {
      try {
        const call = await apiFetch(`/api/calls/${callId}`);
        const c = call;
        document.getElementById('modalTitle').textContent = `Call ${c.call_type === 'inbound' ? 'üì• Inbound' : 'üì§ Outbound'} ‚Äî ${c.id.slice(0, 8)}`;
        document.getElementById('modalMeta').textContent = `${new Date(c.started_at).toLocaleString('tr-TR')} ‚Ä¢ Duration: ${c.duration ? Math.floor(c.duration / 60) + 'm ' + (c.duration % 60) + 's' : '‚Äî'}`;

        const body = `
          <div class="detail-grid">
            <div class="detail-item"><div class="detail-label">Caller</div><div class="detail-value">${c.caller_number || '‚Äî'}</div></div>
            <div class="detail-item"><div class="detail-label">Agent</div><div class="detail-value">${c.agent_name || '‚Äî'}</div></div>
            <div class="detail-item"><div class="detail-label">Queue</div><div class="detail-value">${c.queue_name || '‚Äî'}</div></div>
            <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value"><span class="badge ${c.status === 'completed' ? 'badge-green' : 'badge-red'}">${c.status}</span></div></div>
            <div class="detail-item"><div class="detail-label">Sentiment</div><div class="detail-value">${sentimentPill(c.sentiment_score)}</div></div>
            <div class="detail-item"><div class="detail-label">Intent</div><div class="detail-value">${intentBadge(c.intent)}</div></div>
            <div class="detail-item"><div class="detail-label">Resolution</div><div class="detail-value">${c.resolution_status || '‚Äî'}</div></div>
            <div class="detail-item"><div class="detail-label">Recording</div><div class="detail-value" style="font-size:12px">${c.recording_url ? 'üéôÔ∏è Available' : '‚Äî'}</div></div>
          </div>

          ${c.ai_summary ? `<div class="ai-section">
            <h4>ü§ñ AI Summary</h4>
            <p>${c.ai_summary}</p>
          </div>` : ''}

          ${c.ai_next_action ? `<div class="ai-section">
            <h4>‚ö° Suggested Next Action</h4>
            <p>${c.ai_next_action}</p>
          </div>` : ''}

          ${c.transcript_text ? `<div class="ai-section">
            <h4>üìù Transcript</h4>
            <div class="transcript-box">${c.transcript_text}</div>
          </div>` : ''}
        `;

        document.getElementById('modalBody').innerHTML = body;
        document.getElementById('callModal').classList.add('active');
      } catch (err) {
        console.error('Failed to load call:', err);
      }
    }

    function closeModal() {
      document.getElementById('callModal').classList.remove('active');
    }

    document.getElementById('callModal').addEventListener('click', function (e) {
      if (e.target === this) closeModal();
    });

    // Auto-login
    (function init() {
      const savedToken = localStorage.getItem('cc_token');
      const savedTenant = localStorage.getItem('cc_tenant');
      if (savedToken && savedTenant) {
        token = savedToken; currentTenant = savedTenant;
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadDashboard();
      }
    })();
  </script>
</body>

</html>